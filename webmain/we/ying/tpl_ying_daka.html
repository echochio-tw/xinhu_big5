<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
<title><?=$da['title']?></title>
<link rel="stylesheet" type="text/css" href="mode/weui/weui.min.css"/>
<link rel="stylesheet" type="text/css" href="web/res/fontawesome/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="webmain/css/rui.css">
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/js.js"></script>
<script type="text/javascript" src="js/jswx.js"></script>
<script type="text/javascript" src="js/base64-min.js"></script>
<script charset="utf-8" src="https://map.qq.com/api/js?v=2.exp&libraries=convertor,geometry"></script>
<script type="text/javascript" src="js/dingwei.js"></script>
<style>
.weui_tabbar_icon{text-align:center;color:#888888;font-size:20px;}
.weui_tabbar_item{padding-top:2px;margin-bottom:5px;position:relative}
.weui_bar_item_on .weui_tabbar_icon{color:#1389D3}
</style>
<script>
var kqrs = <?=json_encode($kqrs);?>,kqors = <?=json_encode($kqors);?>,kqallrs=[],isgzh = <?=$isgzh?>;
js.servernow = '<?=$rock->now?>';

var label='',accuracy=0,latitude='',longitude='',kqjuli=-1,addbo = true,explain='',dakaci=1;

function initbody(){
	js.getsplit();
	showtimessabc();
	showkqrswz();
	
	kqallrs.push(kqrs);
	for(var i in kqors)kqallrs.push(kqors[i]);
	
	addkqinfor(0);
}

function addkqinfor(bo){
	js.ajax('kaoqin','getshang',{},function(ret){
		var sbarr = ret.sbarr,s='',rs;
		s='<table width="100%"  class="r-border-t">';
		for(var i=0;i<sbarr.length;i++){
			rs = sbarr[i];
			if(i>0)s+='<tr><td colspan="2"><div style="margin:0px 10px" class="r-border-t"></div></td></tr>';
			s+='<tr><td align="center" nowrap height="60px"><div style="padding:0px 20px"><b>'+rs.name+'</b></div></td><td width="99%"><div style="color:#888888;font-size:14px">'+rs.stime.substr(0,5)+'-'+rs.etime.substr(0,5)+'</div><div>'+rs.state+'</div></td></tr>';
		}
		s+='</table>';
		$('#shangbshow').html(s);
		
		var dkarr = ret.dkarr;
		var s = '',i,oi=1;
		for(i=0;i<dkarr.length;i++){
			s+='，'+dkarr[i].dktime+'';
			oi++;
		}
		if(s!='')s=s.substr(1);
		$('#todyadak').html(s);
		dakaci = oi;
		if(bo==0){
			$('#dkbtn').html('第'+oi+'次打卡');
			js.dw.init(isgzh); //定位開始
		}
	},'mode', false,false, 'get');
}

function showtimessabc(){
	var dt = js.serverdt('Y年m月d日(星期W) H:i:s').split(' ');
	$('#dtstr').html(dt[0]);
	$('#timess').html(dt[1]);
	setTimeout('showtimessabc()',1000);
}

//顯示考勤位置
function showkqrswz(){
	var s = '';
	if(kqrs){
		s+=','+kqrs.name+'';
		if(kqrs.iswgd=='1')s=',無固定位置';
		if(kqors && kqrs.iswgd=='0')for(var i=0;i<kqors.length;i++){
			s+=','+kqors[i].name+'';
			if(kqors[i].iswgd=='1'){
				s=',無固定位置';
				break;
			}
		}
	}
	if(s=='')s='沒設置考勤位置';
	if(s!='')s=s.substr(1);
	$('#weizhi').html(s);
}

js.dw.ondwwait=function(msg){
	latitude = '';
	$('#dwshow').html('<img src="images/loadings.gif" height="14px" align="absmiddle"> '+msg+'');
	return true;
}

js.dw.ondwerr=function(msg){
	latitude = '';
	$('#dwshow').html(''+msg+',<a href="javascript:;" onclick="js.dw.start()">[在定位]</a>');
}

//定位成功後回調
js.dw.ondwcall = function(res){
	latitude 	= res.latitude;
	longitude 	= res.longitude;
	accuracy 	= res.accuracy;
	label		= res.address;
	var center	= res.center;
	$('#dwshow').html(''+res.addressinfo+',<a href="javascript:;" onclick="js.dw.start()">[更新]</a>');
	var i,kqrsa,enddt,juli;
	
	addbo		= true;//可以添加記錄
	for(i=0;i<kqallrs.length;i++){
		kqrsa = kqallrs[i];
		enddt = new qq.maps.LatLng(parseFloat(kqrsa.location_x), parseFloat(kqrsa.location_y));
		juli  = parseInt(qq.maps.geometry.spherical.computeDistanceBetween(center, enddt));
		if(juli<0)juli = 0-juli;
		if(kqrsa['iswgd']=='1')juli=0; //無固定位置的
		kqallrs[i]['kqjuli'] = juli;
		kqjuli = juli;
	}
	
	if(!isfenwein()){
		$('#dkbtnto').addClass('btnwai');
		$('#dkbtn').html('保存定位');
	}else{
		$('#dkbtnto').removeClass('btnwai');
		$('#dkbtn').html('第'+dakaci+'次打卡');
	}
}

//判斷有沒有在考勤地點上
function isfenwein(){
	var i,kqrsa,slju,sljus,iskqbo=false;
	for(i=0;i<kqallrs.length;i++){
		kqrsa 	= kqallrs[i];
		slju	= parseFloat(kqrsa.precision);
		sljus	= parseFloat(kqrsa.kqjuli);
		if(sljus<=slju)iskqbo = true;
	}
	kqwucha = slju;
	return iskqbo;
}
var addkaoqinbool=false;
function addkaoqin(o1){
	if(addkaoqinbool){
		js.wx.alert('已保存過了，請退出頁面');
		return;
	}
	if(js.dw.dwbool){js.wx.alert('正在定位，稍後在添加');return;}
	if(latitude=='' || kqjuli==-1){js.wx.alert('定位沒有成功，不能添加');return;}
	if(!addbo){js.wx.alert('請重新定位後在打卡');return;}
	//if(!isfenwein()){js.wx.alert('當前位置距離考勤點有'+kqjuli+'米,考勤設置誤差不能超過'+kqwucha+'米，故不能添加考勤打卡！');return;}
	if(isfenwein()){
		adddk('打卡',1);
	}else{
		adddk('保存',0);
	}
}

function adddk(ts, lx){
	var o1 = get('dkbtn');
	$(o1).html(''+ts+'中...');
	var data = {location_x:latitude,type:lx,location_y:longitude,scale:12,precision:accuracy,label:jm.base64encode(label),sm:jm.base64encode(explain)};
	addkaoqinbool = true;
	js.ajax('weixin','addlocation',data,function(ret){
		js.wx.alert(''+ts+'成功:'+ret.now+'');
		$(o1).html(''+ts+'成功');
		addbo = false;
		addkqinfor(1);
	},'none');	
}

function addbeizhu(o1){
	js.wx.prompt('加備注','請輸入備注說明：',function(txt){
		explain = txt;
		if(txt){
			$(o1).html('備注：'+txt+'');
		}else{
			$(o1).html('加備注...');
		}
	});
}

function changetab(lx){
	var url='?d=we&m=ying&a=location';
	if(lx==2)url='?m=ying&d=we&num=kqtotal';
	js.location(url);
}
</script>
<style>
.addbtns{ background:#C5E0F7;padding:5px;margin-top:20px;width:100px;height:100px;border-radius:50%}
.addbtnss{right:10px;bottom:10px;width:100px;height:100px; background:#4E9CE0;opacity:0.8;z-index:1;border-radius:50%;font-size:16px;color:white;text-align:center;line-height:98px;}
.addbtnss:active{opacity:1}

.btnwai{background:#FCD5BA}
.btnwai .addbtnss{background:#ff6600}
</style>
</head>


<body>
<?php if($showheader==1){?>
<div>
	<div class="r-header">
		<div class="r-header-text" onclick="location.reload()" id="header_title"><?=$da['title']?></div>
		<span onclick="js.back()" class="r-position-left r-header-btn"><i class="icon-chevron-left"></i></span>
	</div>
	<div class="blank50"></div>
</div>
<?php }?>
<div align="center"  style="background:white;padding-bottom:10px">
	<div id="timess" onclick="location.reload()" style="font-size:40px">15:10:00</div>
	<div id="dtstr" style="font-size:14px"><?=date('Y年m月d日')?>(星期三)</div>
	<div class="blank5"></div>
	<div id="dwshow" style="font-size:14px;color:#aaaaaa;padding:0px 10px">等待定位</div>

</div>
<div class="r-padding10 r-border-t" style="background:white;padding:15px 10px; background-color:#f5f5f5">考勤範圍：<font color="#888888" id="weizhi">沒設置考勤位置</font></div>
<div id="shangbshow" style="background:white">
<table width="100%"  class="r-border-t">
<tr><td align="center" nowrap height="60px"><div style="padding:0px 20px"><b>上班</b></div></td><td width="99%"><div style="color:#888888;font-size:14px">09:00-12:00</div><div><font color=#888888>加載中</font></div></td></tr>
<tr><td colspan="2"><div style="margin:0px 10px" class="r-border-t"></div></td></tr><tr><td align="center" nowrap height="60px"><div style="padding:0px 20px"><b>下班</b></div></td><td width="99%"><div style="color:#888888;font-size:14px">13:00-18:00</div><div><font color=#888888>加載中</font></div></td></tr>
</table>
</div>
<div class="r-border-t"></div>
<div align="center">
	<div id="dkbtnto" class="addbtns">
		<div class="addbtnss" id="dkbtn" onclick="addkaoqin(this)">第1次打卡</div>
	</div>
</div>
<div class="r-padding10" align="center" style="font-size:14px;"><a id="beshuomdiv" onclick="addbeizhu(this)" href="javascript:;">加備注...</a></div>
<div class="r-padding10 r-wrap" align="center" style="font-size:14px;color:#888888;">今日打卡：<span id="todyadak">無</id></div>


<div style="height:55px; overflow:hidden"></div>	
<div style="height:55px;overflow:hidden;z-index:2;position:fixed" class="weui_tabbar">
	<a href="javascript:;" class="weui_tabbar_item weui_bar_item_on">
		<div class="weui_tabbar_icon">
			<i class="icon-time"></i>
		</div>
		<p class="weui_tabbar_label"><?=$da['title']?></p>
	</a>
	<a href="javascript:;" onclick="changetab(1)" class="weui_tabbar_item">
		<div class="weui_tabbar_icon">
			<i class="icon-fighter-jet"></i>
		</div>
		<p class="weui_tabbar_label">外勤定位</p>
	</a>
	<a href="javascript:;" onclick="changetab(2)" class="weui_tabbar_item">
		<div class="weui_tabbar_icon">
			<i class="icon-bar-chart"></i>
		</div>
		<p class="weui_tabbar_label">考勤統計</p>
	</a>
</div>
</body>
</html>